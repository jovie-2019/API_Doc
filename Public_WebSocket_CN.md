# Web Socket 行情接口(2019-11-21)
# 基本信息
* 本篇所列出的所有wss接口的baseurl为: **wss://stream.zg.com/connect**
* 每个到**zg.com**的链接有效期不超过4小时，请妥善处理断线重连。
* 每1分钟,客户端需要主动发送PING消息给服务端,保持心跳连接,服务在超过一定时间未收到PING消息会将把客户端踢下线。


## 逐笔交易
逐笔交易推送每一笔成交的信息。

**reuqest 内容:** {"type":"\<symbol\>@trade"}

**Payload:**
```javascript
{
    "i":70676,// 消息id
    "e":"trade",// 事件类型
    "E":1574315981, // 事件时间
    "s":"BTC_USDT",// 交易对
    "t":6085147, //  成交ID
    "p":"8224.59",// 成交价格
    "q":"0.5838",// 成交数量
    "d":"BUY",// 买卖方向
    "T":1574315981, // 成交时间
    "m":false
}
```

## K线
K线stream逐秒推送所请求的K线种类(最新一根K线)的更新

**订阅Kline需要提供间隔参数。支持以下间隔(interval):**

m -> 分钟; h -> 小时; d -> 天;

* 1m
* 5m
* 15m
* 30m
* 1h
* 4h
* 1d
* 5d
* 7d
* 30d

**Stream 名称:** {"type":"\<symbol\>@klines_\<interval\>"}

**Payload:**
```javascript
{
  "e":"klines",
  "E":1574317686,//事件时间
  "s":"BTC_USDT",//交易对
  "k":
    {
      "t":1574317680,//开始时间
      "T":1574317739,//结束时间
      "i":"klines_1m",//k线间隔
      "o":"8218.99",//开盘价
      "c":"8203.54",//收盘价
      "h":"8218.99",//最高价
      "l":"8203.54",//最低价
      "v":"0.7122",//累计成交量
      "n":1,//累计成交笔数
      "q":"5842.561188"//累计成交额
    }
}
```

## 按Symbol的精简Ticker
按Symbol逐秒刷新精简ticker信息

**Stream 名称:** {"type":"\<symbol\>@miniTicker"}

**Payload:**
```javascript
{
    "e":"miniTicker",// 事件类型
    "E":1574316675,// 事件时间
    "s":"BTC_USDT",// 交易对
    "c":"8223.49",// 最新成交价格
    "o":"8174.49",// 整整24小时前，向后数的第一次成交价格
    "h":"8235.76",// 24小时内最高成交价
    "l":"8161.71",// 24小时内最低成交加
    "v":"0.7519",// 24小时内成交量
    "q":"6183.24213100"// 24小时内成交额
}
```

## 全市场所有Symbol的精简Ticker
同上，只是推送所有交易对

**Stream名称:** {"type":"@allMiniTicker"}

**Payload:**
```javascript
[
  {
    // 数组每一个元素对应一个交易对，内容与 \<symbol\>@miniTicker相同
  }
]
```

## 按Symbol的完整Ticker
按Symbol逐秒刷新的24小时完整ticker信息

**Stream 名称:** {"type":"\<symbol\>@ticker"}

**Payload:**
```javascript
{
    "i":71202,// 消息id
    "e":"ticker",// 事件类型
    "E":1574316510,// 事件时间
    "s":"BTC_USDT",// 交易对
    "p":"-2.88",// 24小时价格变化
    "P":"-0.00035109",// 24小时价格变化（百分比）
    "w":"8198.14597116",// 平均价格
    "x":"8203.03",// 整整24小时之前，向前数的最后一次成交价格
    "c":"8200.15",// 最新成交价格
    "Q":"0.7451",// 最新成交交易的成交量
    "o":"8207.77",// 整整24小时前，向后数的第一次成交价格
    "h":"8235.76",// 24小时内最高成交价
    "l":"8161.71",// 24小时内最低成交加
    "v":"19757.4564",// 24小时内成交量
    "q":"161974511.58606535",// 24小时内成交额
    "F":6020860,//24小时内第一笔成交交易ID
    "L":6085673,// 24小时内最后一笔成交交易ID
    "n":30169// 24小时内成交数
}
```

## 全市场所有交易对的完整Ticker
同上，只是推送所有交易对

**Stream名称:** {"type":"@allTicker"} 

**Payload:**
```javascript
[
  {
    // 对应每一个交易对的 <symbol>@ticker 内容
  }
]
```



## 增量深度信息stream
每秒推送orderbook的变化部分（如果有）

**Stream 名称:** {"type":"\<symbol\>@depth"}

**Payload:**
```javascript
{
  "e":"depthUpdate",//事件类型
  "E":1574316982451,//事件时间
  "s":"BTC_USDT",//交易对
  "u":63,//更新id
  //买
  "b":
    [
      ["10","59"]
    ],
  //卖
  "a":[]
  }
```

## 如何正确在本地维护一个orderbook副本
1. 完成depth的订阅
2. 开始缓存收到的更新。同一个价位，后收到的更新覆盖前面的。
3. 访问Rest接口 **https://api.zg.com/market/api/v1/depth?symbol=BTC_USDT&limit=100** 获得一个100档的深度快照
4. 将目前缓存到的信息中`u`小于步骤3中获取到的快照中的`lastUpdateId`的部分丢弃(丢弃更早的信息，已经过期)。
5. 将深度快照中的内容更新到本地orderbook副本中，并从websocket接收到的第一个`U` <= `lastUpdateId`+1 **且** `u` >= `lastUpdateId`+1 的event开始继续更新本地副本。
6. 每一个新event的`u`应该恰好等于上一个event的`u`+1，否则可能出现了丢包，请从step3重新进行初始化。
7. 每一个event中的挂单量代表这个价格目前的挂单量**绝对值**，而不是相对变化。
8. 如果某个价格对应的挂单量为0，表示该价位的挂单已经撤单或者被吃，应该移除这个价位。

